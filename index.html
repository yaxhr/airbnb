/** @jsxImportSource https://esm.sh/react@18.2.0 */
import React, { useState, useEffect } from "https://esm.sh/react@18.2.0";
import { createRoot } from "https://esm.sh/react-dom@18.2.0/client";

function BunkawayBookingForm() {
  const [guestCount, setGuestCount] = useState(1);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [formData, setFormData] = useState({
    guests: Array(4).fill({
      name: '',
      contact: '',
      frontId: null,
      backId: null
    }),
    property: '',
    room: '',
    checkIn: '',
    checkOut: ''
  });

  // Simulated booking database
  const [bookings, setBookings] = useState([
    { 
      property: 'Bunkaway Indore', 
      room: 'Bunkaway Flat No. 302', 
      checkIn: '2024-02-10T14:00', 
      checkOut: '2024-02-15T11:00' 
    }
  ]);

  const properties = {
    'Bunkaway Chandigarh': {
      '': { 
        rooms: [], 
        price: 2500 
      }
    },
    'Bunkaway Indore': {
      '': { 
        rooms: ['Bunkaway Flat No. 302', 'Bunkaway Flat No. 202', 'Bunkaway Flat No. 101'], 
        price: 3500 
      }
    },
    'Bunkaway Mohali': {
      '': { 
        rooms: [], 
        price: 2800 
      }
    }
  };

  const isRoomAvailable = (property, room, checkIn, checkOut) => {
    return !bookings.some(booking => 
      booking.property === property && 
      booking.room === room && 
      !(new Date(checkOut) <= new Date(booking.checkIn) || 
        new Date(checkIn) >= new Date(booking.checkOut))
    );
  };

  const validateContact = (contact) => {
    // Validate either email or phone number
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const phoneRegex = /^[+]?[(]?[0-9]{3}[)]?[-\s.]?[0-9]{3}[-\s.]?[0-9]{4,6}$/;
    return emailRegex.test(contact) || phoneRegex.test(contact);
  };

  const handleInputChange = (field, value, guestIndex = null) => {
    if (guestIndex !== null) {
      const updatedGuests = [...formData.guests];
      updatedGuests[guestIndex] = {
        ...updatedGuests[guestIndex],
        [field]: value
      };
      setFormData(prev => ({ ...prev, guests: updatedGuests }));
    } else {
      setFormData(prev => ({ ...prev, [field]: value }));
    }
  };

  const handleFileUpload = (field, file, guestIndex) => {
    handleInputChange(field, file, guestIndex);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    // Validate contact for each guest
    const invalidContacts = formData.guests.slice(0, guestCount).some(guest => 
      !validateContact(guest.contact)
    );

    if (invalidContacts) {
      alert('Please enter a valid email or phone number for each guest');
      return;
    }

    setIsSubmitting(true);

    const { email } = await import("https://esm.town/v/std/email");
    
    // Prepare file uploads
    const uploadPromises = formData.guests.slice(0, guestCount).map(async (guest, index) => {
      if (guest.frontId instanceof File && guest.backId instanceof File) {
        const frontIdBlob = await guest.frontId.arrayBuffer();
        const backIdBlob = await guest.backId.arrayBuffer();
        
        return {
          frontIdName: guest.frontId.name,
          backIdName: guest.backId.name,
          frontIdContent: btoa(String.fromCharCode.apply(null, new Uint8Array(frontIdBlob))),
          backIdContent: btoa(String.fromCharCode.apply(null, new Uint8Array(backIdBlob)))
        };
      }
      return null;
    });

    const uploadedFiles = await Promise.all(uploadPromises);

    const emailBody = `
      üè® Bunkaway Booking Request üè®

      Booking Details:
      ----------------
      Property: ${formData.property}
      Room: ${formData.room}
      Check-In: ${new Date(formData.checkIn).toLocaleString()}
      Check-Out: ${new Date(formData.checkOut).toLocaleString()}

      Guest Details:
      --------------
      ${formData.guests.slice(0, guestCount).map((guest, index) => `
        Guest ${index + 1}:
        - Name: ${guest.name}
        - Contact: ${guest.contact}
        - Government ID:
          * Front ID: ${uploadedFiles[index]?.frontIdName || 'Not Uploaded'}
          * Back ID: ${uploadedFiles[index]?.backIdName || 'Not Uploaded'}
      `).join('\n')}

      Please review and respond to the booking request.
    `;

    try {
      // Flatten attachments array and filter out null values
      const attachments = uploadedFiles
        .filter(file => file)
        .flatMap((file, index) => [
          {
            filename: `Guest${index + 1}_FrontID.jpg`,
            content: file.frontIdContent,
            encoding: 'base64'
          },
          {
            filename: `Guest${index + 1}_BackID.jpg`,
            content: file.backIdContent,
            encoding: 'base64'
          }
        ]);

      await email({
        to: ['bunkaway.booking@gmail.com'],
        subject: `New Booking Request - ${formData.property} - ${formData.room}`,
        text: emailBody,
        attachments: attachments
      });

      // Simulate booking
      setBookings(prev => [...prev, {
        property: formData.property,
        room: formData.room,
        checkIn: formData.checkIn,
        checkOut: formData.checkOut
      }]);

      // Show modal/popup
      alert('Please wait for the Host\'s Response');
    } catch (error) {
      console.error('Booking submission error:', error);
      alert('Failed to submit booking. Please try again.');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div style={styles.container}>
      <div style={styles.header}>
        <h1 style={styles.title}>üè® Bunkaway Booking</h1>
      </div>
      <form onSubmit={handleSubmit} style={styles.form}>
        <div style={styles.formGroup}>
          <label style={styles.label}>Guests</label>
          <select 
            style={styles.select}
            value={guestCount} 
            onChange={(e) => setGuestCount(Number(e.target.value))}
          >
            {[1, 2, 3, 4].map(num => (
              <option key={num} value={num}>{num} Guest{num > 1 ? 's' : ''}</option>
            ))}
          </select>
        </div>

        <div style={styles.formGroup}>
          <label style={styles.label}>Property</label>
          <select 
            style={styles.select}
            value={formData.property} 
            onChange={(e) => {
              handleInputChange('property', e.target.value);
              handleInputChange('room', '');
            }}
          >
            <option value="">Select Property</option>
            {Object.keys(properties).map(location => (
              <option 
                key={location} 
                value={location}
              >
                {location}
              </option>
            ))}
          </select>
        </div>

        {formData.property && (
          <div style={styles.formGroup}>
            <label style={styles.label}>Room</label>
            <select 
              style={styles.select}
              value={formData.room}
              onChange={(e) => handleInputChange('room', e.target.value)}
              required
            >
              <option value="">Select Room</option>
              {formData.property && Object.keys(properties).map(location => 
                location === formData.property &&
                properties[location][''].rooms.map(room => {
                  const isAvailable = formData.checkIn && formData.checkOut 
                    ? isRoomAvailable(formData.property, room, formData.checkIn, formData.checkOut)
                    : true;
                  return (
                    <option 
                      key={room} 
                      value={room} 
                      disabled={!isAvailable}
                    >
                      {room} {isAvailable ? '‚úÖ' : 'üö´'}
                    </option>
                  );
                })
              )}
            </select>
          </div>
        )}

        <div style={styles.dateGroup}>
          <div style={styles.formGroup}>
            <label style={styles.label}>Check-In</label>
            <input 
              type="datetime-local" 
              style={styles.dateInput}
              value={formData.checkIn}
              onChange={(e) => handleInputChange('checkIn', e.target.value)}
              required 
            />
          </div>
          <div style={styles.formGroup}>
            <label style={styles.label}>Check-Out</label>
            <input 
              type="datetime-local" 
              style={styles.dateInput}
              value={formData.checkOut}
              onChange={(e) => handleInputChange('checkOut', e.target.value)}
              required 
            />
          </div>
        </div>

        {formData.guests.slice(0, guestCount).map((guest, index) => (
          <div key={index} style={styles.guestSection}>
            <h3 style={styles.guestTitle}>Guest {index + 1}</h3>
            <div style={styles.formGroup}>
              <label style={styles.label}>Full Name</label>
              <input 
                type="text" 
                style={styles.input}
                value={guest.name}
                onChange={(e) => handleInputChange('name', e.target.value, index)}
                required 
              />
            </div>
            <div style={styles.formGroup}>
              <label style={styles.label}>Email or Phone Number</label>
              <input 
                type="text" 
                style={styles.input}
                placeholder="Enter email or phone number"
                value={guest.contact}
                onChange={(e) => handleInputChange('contact', e.target.value, index)}
                required 
              />
              <small style={styles.helperText}>
                Enter a valid email (e.g., example@email.com) or phone number
              </small>
            </div>
            <div style={styles.formGroup}>
              <label style={styles.label}>Government ID (Front)</label>
              <input 
                type="file" 
                style={styles.fileInput}
                accept="image/*"
                onChange={(e) => handleFileUpload('frontId', e.target.files[0], index)}
                required 
              />
            </div>
            <div style={styles.formGroup}>
              <label style={styles.label}>Government ID (Back)</label>
              <input 
                type="file" 
                style={styles.fileInput}
                accept="image/*"
                onChange={(e) => handleFileUpload('backId', e.target.files[0], index)}
                required 
              />
            </div>
          </div>
        ))}

        <button 
          type="submit" 
          style={styles.submitButton}
          disabled={isSubmitting}
        >
          {isSubmitting ? 'Submitting...' : 'Book Now'}
        </button>
      </form>
    </div>
  );
}

const styles = {
  container: {
    fontFamily: "'Circular', -apple-system, BlinkMacSystemFont, Roboto, Helvetica Neue, sans-serif",
    maxWidth: '600px',
    margin: 'auto',
    padding: '20px',
    backgroundColor: '#f7f7f7',
    borderRadius: '12px',
    boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
  },
  header: {
 textAlign: 'center',
    marginBottom: '20px'
  },
  title: {
    fontSize: '24px',
    color: '#484848',
    fontWeight: '600'
  },
  form: {
    display: 'flex',
    flexDirection: 'column',
    gap: '15px'
  },
  formGroup: {
    display: 'flex',
    flexDirection: 'column',
    gap: '5px'
  },
  label: {
    fontSize: '14px',
    color: '#717171',
    fontWeight: '600'
  },
  select: {
    padding: '10px',
    borderRadius: '8px',
    border: '1px solid #EBEBEB',
    fontSize: '16px'
  },
  input: {
    padding: '10px',
    borderRadius: '8px',
    border: '1px solid #EBEBEB',
    fontSize: '16px'
  },
  fileInput: {
    padding: '10px',
    borderRadius: '8px',
    backgroundColor: 'white'
  },
  dateGroup: {
    display: 'flex',
    gap: '15px'
  },
  dateInput: {
    padding: '10px',
    borderRadius: '8px',
    border: '1px solid #EBEBEB',
    fontSize: '16px',
    width: '100%'
  },
  guestSection: {
    backgroundColor: 'white',
    padding: '15px',
    borderRadius: '12px',
    border: '1px solid #EBEBEB'
  },
  guestTitle: {
    margin: '0 0 10px 0',
    color: '#484848'
  },
  submitButton: {
    backgroundColor: '#FF5A5F',
    color: 'white',
    padding: '12px',
    borderRadius: '8px',
    border: 'none',
    fontSize: '16px',
    fontWeight: '600',
    cursor: 'pointer',
    transition: 'background-color 0.3s ease'
  },
  helperText: {
    fontSize: '12px',
    color: '#717171',
    marginTop: '5px'
  }
};

function client() {
  createRoot(document.getElementById("root")).render(<BunkawayBookingForm />);
}
if (typeof document !== "undefined") { client(); }

export default async function server(request: Request): Promise<Response> {
  return new Response(`
    <html>
      <head>
        <title>Bunkaway Booking</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://esm.town/v/std/catch"></script>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;600&display=swap" rel="stylesheet">
      </head>
      <body style="margin: 0; background-color: #f7f7f7;">
        <div id="root"></div>
        <script type="module" src="${import.meta.url}"></script>
      </body>
    </html>
  `, {
    headers: { "content-type": "text/html" }
  });
}